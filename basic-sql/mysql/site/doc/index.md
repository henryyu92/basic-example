## 索引

索引是一种数据结构，存储引擎使用索引来快速查找记录。索引以文件的形式存储在磁盘中，当数据新增或者删除时索引文件的结构会发生变化，因此当一个表中建立了大量索引后也会使得新增和删除的性能下降。

MySQL 中常用的索引有 Hash 索引和 B+ 树索引，其中 Hash 索引将数据映射到哈希表中，B+ 树索引则构建了 B+ 树的数据结构管理索引值和数据的映射。

### Hash 索引

Hash 索引使用 Hash 算法将数据映射到哈希表中，因此对于字典类型的查找非常快速，但是对于范围查询就无能为力了。

### B+ 树索引

B+ 树索引并不能根据键值找到具体的行数据，B+ 树索引只能找到行数据所在的页，然后将页读取到内存并在内存中查找到行数据。

B+ 树索引的本质是B+树数据结构在数据库中的实现，在数据库中 B+ 树的高度一般都在 2-4 层，也就是说查找某一键值的行记录时最多只需要 2-4 此 IO 操作。

B+ 树是 B 树的变形，具有一些独特的特点：
- 内部节点(非叶子节点)只保存索引(即指向子节点的指针)，数据都存储在叶子节点
- B+ 树同 B 树一样是一棵平衡树，其左子树的 key 小于内部节点的 key，右子树都大于等于内部节点的 key
- B+ 树的叶子节点都存有相邻叶子节点的指针，叶子节点本身按照关键字的大小而从大到小顺序链接
- B+ 树中的中间节点同时存在于子节点，在子节点元素中是最大或最小元素

数据库中的 B+ 树索引可以分为聚簇索引(clustered index)和辅助索引(secondary index)，不管是聚簇索引还是辅助索引其内部都是 B+ 树，即高度是平衡的，叶子节点存放着所有的数据；聚簇索引与辅助索引的不同是叶子节点存放的的是否是一整行的信息

#### 聚簇索引(clustered index)  
InnoDB 存储引擎表是索引组织表，即表中数据按照主键顺序存放。聚簇索引按照每张表的主键构造一棵 B+ 树，同时叶子节点中存放的即为整张表的行记录数据，也将聚簇索引的叶子节点称为数据页；每个数据页都通过一个双向链表来进行链接，每个页中的记录也是通过双向链表进行维护。

实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚簇索引；数据页上存放的是完整的每行的记录，而在非数据页的索引页中，存放的仅仅是键值及指向数据页的偏移量，而不是一个完整的行记录。

聚簇索引的好处是它对于主键的排序查找和范围查找速度非常快，叶子节点的数据就是所要查询的数据。

#### 辅助索引(secondary index)  
辅助索引的叶子节点并不包含行记录的全部数据；叶子节点处理包含键值以外，每个叶子节点中的索引行还包含了一个书签(bookmark)，对应相应行数据的聚簇索引键(主键)。

辅助索引的存在并不会影响数据在聚簇索引中的组织，因此每张表上可以有多个辅助索引；当通过辅助索引来寻找数据时，InnoDB 存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后通过主键索引来找到一个完整的行记录。
#### B+树索引的管理
索引可以在表创建之后使用 ```alter``` 命令创建和删除： 
```sql
alter table tbl_name add index index_name(index_col_name...)  
alter table tbl_name drop index index_name
```
在创建表的时候也可以创建索引：
```sql
create index index_name on tbl_name(index_col_name...)  
```
删除索引还可以直接使用 ```drop``` 命令：
```sql
drop index index_name on tbl_name
```
索引创建后可以使用 ```show``` 命令查看：  
```sql
show index from tbl_name
```
show 命令可以看到索引的详细信息：
- Table：索引所在的表名
- Non_unique：非唯一索引，0 表示是唯一索引，1 表示是非唯一索引
- Key_name：索引的名字
- Seq_in_index：索引中该列的位置
- Column_name：索引列的名称
- Collation：列在索引中的存储方式，B+树索引是A
- Cardinality：表示索引中唯一值的数目的估计值，cardinality/count(1) 接近 1 比较好，如果太低就需要考虑索引的必要性了  
  - Sub_part：索引列是否是部分索引  
  - Packed：关键字压缩方式  
  - Null：索引列中是否含有 Null 值  
  - Index_type：索引的类型  
  - Comment：注释  
#### 联合索引  
联合索引是指对表上的多个列进行索引。联合索引基于左前缀匹配规则。
#### 覆盖索引(covering index)  
覆盖索引指的是从辅助索引中就可以得到查询的数据，而不需要再次查询聚簇索引而得到数据，因而能够减少大量的 I/O 操作。

对于 InnoDB 存储引擎的辅助索引而言，由于其包含了主键信息，因此其叶子节点存放的数据为 (primary_key1,..., key1, key2,...)，在只需要查找索引键的查询中只需要使用一次辅助联合索引来完成查询：
```sql
-- key1, key2 是联合索引 
select primary_key1, key2 from table where key1='';
```
