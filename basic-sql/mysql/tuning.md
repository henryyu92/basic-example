## 调优

MySQL 调优一般是通过慢查询日志找到需要优化的 SQL，然后通过 explain 信息得到该 SQL 的执行计划，根据执行计划调整 SQL。

- 通过 `explain` 查看执行计划(id 大的先执行，id 相同上面的先执行)，判断查询是否使用到索引，以及是否有全表扫描、filesort
- 小数据集驱动大数据集，表连接时需要指定连接条件防止出现笛卡尔积，关联列需要建立索引
- 对于需要排序的字段最好建立索引，防止出现 filesort
- 对于 in 或者 exist 这种查询可以优化为表关联查询
- 对于 or 这种查询可以优化为 union 查询

### 索引优化

- 如果列经常出现在 where 查询条件中，并且列的分布均匀，则建立索引效果比较好
- 回表的次数和辅助索引查询出的数量相同，因此如果使用辅助索引最好减少回表，通常可以使用联合索引来直接获取需要的列，也就是说在查询中最好不要使用 `select * ` 这种查询

### 表关联

在多表连接的时候，一般情况下是两个表先关联，关联之后再和其他表关联。

#### 嵌套循环

驱动表返回每行数据都传值给被驱动表用于查询，因此驱动表返回多少行，被驱动表就需要执行多少次扫描

嵌套循环驱动表需要返回较少的数据，而被驱动表则必须使用索引。

对于外连接来说驱动表固定了，此时需要保证被驱动表能够走索引

```sql
-- b.id 建立了索引
select a.*, b.* from a join b on a.id = b.id
```



#### 哈希连接

哈希连接是两个表的等值连接，将较小的表作为驱动表，将驱动表的 select 列和 join 列读取到内存中并对驱动表的连接列进行 hash 运算，然后被驱动表的连接列进行 hash 运算并和驱动表进行比较。如果驱动表比较大则会产生磁盘 hash 连接，此时性能就会严重下降。

```sql
-- b.id 没有设置索引
select a.*, b.* a join b on a.id = b.id
```

嵌套循环每循环一次会将驱动表连接列的值传给被驱动表，而哈希连接没有传值的过程，而是直接比较，因此 hash 连接不需要索引。

对于哈希连接需要避免使用 `select * from` 这种写法，减少内存的占用。

#### 排序合并连接

排序合并连接主要用于处理两表非等值关联，比如 `>`、`>=`、`<`、`<=`、`<>` 等。

```sql
select * from a, b where a.id >= b.id
```

排序合并连接的算法：两表关联，先对两个表根据连接列进行排序，将较小的表作为驱动表，然后从驱动表中取出连接列的值到已经排好序的被驱动表中匹配数据，如果匹配上则关联成功

#### 笛卡尔连接

两个表关联没有连接条件的时候会产生笛卡尔积，这种表连接的方式称为笛卡尔连接

```sql
select a.*, b.* from a, b;
```

#### 标量子查询

当子查询介于 select 和 from 之间，这种子查询称为标量子查询。

```sql
select a.*, (select * from b where b.id = a.id) from a;
```

标量子查询的驱动表为主表，则标量子查询中的表需要对关联列建立索引，否则会导致子查询全表扫描。标量子查询可以改写为外连接，此时如果被驱动表没有创建索引则会使用 hash 连接：

```sql
select a.*, b.* from a left join b on a.id = b.id
```



### 表结构优化

#### 主键

在 Innodb 存储引擎中，如果定义了主键则会将主键作为聚簇索引，如果没有显式定义主键则会选择第一个不包含 null 值的唯一索引作为主键索引。

主键一般设计为自增的，使用自增主键时每次插入新的记录就会顺序添加到当前索引节点的后续位置，当一页写满就会自动开辟一个新的页；如果使用非自增索引(uuid)，由于每次插入主键的值近似与随机，因此每次插入新纪录都需要被插入到索引页的随机位置，造成索引碎片。

自增主键不应该带有业务含义，如果业务数据变动导致不是自增的，后续插入的数据主键比前面的小，可能引发页分裂，产生空间碎片。

### 分库分表

水平分表：以**字段**为依据，按照一定策略（hash、range等），将一个**表**中的数据拆分到多个**表**中

- 每个表的结构都一样
- 每个表的数据都不一样，没有交集
- 所有表的幷集是全量数据

垂直分表：以**表**为依据，按照业务归属不同，将不同的字段拆分到不同的表中

- 每个表的数据结构不同
- 表中的数据也不同，并且没有交集
- 所有表的幷集是全量数据



**[Back](../../)**