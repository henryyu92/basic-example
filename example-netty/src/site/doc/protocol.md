## 网络协议

为进行网络中的数据交换而建立的规则、标准或约定称为网络协议(network protocol)。对于复杂的网络协议，其结构是层次式的，各层及其协议的集合称为网络的体系结构。

OSI 七层体系结构将整个网络协议分为七层：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。
- 应用层：体系结构的最高层，定义的是应用进程间通信和交互的规则，传输的数据单元称为报文(message)
- 传输层：负责向两个主机中进程之间的通信提供通用的数据传输服务。传输层主要使用 TCP(Transmission Control Protocol) 和 UDP(User Datagram Protocol) 两种协议，其中 TCP 协议提供面向连接的、可靠的数据传输服务，数据传输的单位是 **报文段**；UDP 协议提供无连接的、**尽最大努力**的数据传输服务(不保证数据的可靠性)，数据传输的单位是用户数据报
- 网络层：网络层负责为分组交换网上的不同主机提供通信服务，发送数据时将运输层产生的报文段或用户数据报分组或包进行传输。网络层需要选择合适的路由，使源主机运输层的分组能够通过网络中的路由器找到目的主机
- 数据链路层：数据链路层将网络层的 IP 数据报组装成帧(framing)，在两个相邻结点间的链路上传送帧(frame)
- 物理层：物理层上传输的数据是比特(bit)，物理层不需要关注比特的解释，只需要关注如何将电压转换为比特

TCP/IP 四层体系将 OSI 七层模型简化为四层：


## TCP 协议

**TCP 是面向连接的协议**。进程在使用 TCP 协议之前必须建立 TCP 连接，在数据传输完成之后需要释放 TCP 连接。

**TCP 连接是点对点的**，每个 TCP 连接只能有两个端点，

TCP 提供可靠交付的服务，通过 TCP 连接传输的数据，无差错、不丢失、不重复、并且按序到达

TCP 提供全双工通信，TCP 连接两端都设有发送缓冲和接受缓冲，在发送时应用程序的数据发送到缓冲后，TCP 在合适的时候将数据发送出去，在接收时数据存储在缓冲中，应用程序在合适的时候读取缓冲区的数据

TCP 是面向字节流的，TCP 不保证接收的数据块和发送的数据块大小对应(拆包、粘包问题)

TCP 连接的端点叫做套接字(Socket)，由 IP 地址和端口号定义，每一条 TCP 连接唯一的被通信两端的两个端点所确定


### 可靠传输

IP 层只能提供尽最大努力服务，也就是不可靠的，因此 TCP 必须采用适当的措施保证通信变得可靠。

**停止等待**

发送发发送数据后需要等待接收方的确认响应，如果在超过一定时间没有收到确认则会重传之前的数据，这种方式称为超时重传。超时重传需要设置一个定时器，定时器的超时时间必须比数据传输往返时间更长，超时冲虚需要缓存已发送但未收到确认的数据副本以及其编号用于重传。

超时重传接收方接收到的重复数据直接丢弃，并向发送方发送确认；发送方接收到重复的确认直接丢弃。通过超时重传和确认机制可以实现在不可靠的网络上实现可靠的通信。

停止等待需要一个分组数据传送完毕再传送下一个，信道利用率较低，可以将停止等待改为流水线传输，即发送方连续发送多个分组数据而不必每发完一个分组数据就停顿下来等待接收方确认，使得信道上一直有数据传输，提高信道利用率。


**连续 AQR(Automatic Repeat reRequest) 协议**

连续 AQR 是发送方可以连续发送窗口内的分区数据，而不需要等待接收方的确认。连续 AQR 协议规定，发送方每接收到一个确认就需要将窗口滑动一个位置，接收方一般采用累计确认方式，即在收到几个分组数据之后，对按序到达的最后一个分组发送确认，表示这个分组数据之前所有的分区数据已经正确接收到了。

#### TCP 可靠传输协议实现

TCP 的滑动窗口是以字节为单位的，在没有收到接收确认的情况下，发送者可以将滑动窗口中的数据都发送出去。发送窗口里面的序号表示允许发送的序号，窗口越大，发送发就可以在接收方确认之前连续发送更多的数据，从而获得更高的传输效率。

发送窗口的后沿的后面部分表示已经发送且收到的确认，发送窗口的前沿前面的部分表示不允许发送的，因为接收方没有为这部分数据保留临时缓存空间。发送窗口的后沿只有前移和不动两种可能，而前沿也有可能前移和不动两种可能。

后沿前移是收到了接收者的确认，前沿的不动可能是收到了确认但接收者通知的窗口缩小了使得发送窗口的前沿正好不动。

发送窗口需要三个指针描述状态，指针都指向字节的序号：
- 小于 P1 的是已经发送并已收到确认的部分
- 大于 P3 的是不允许发送的部分
- P3-P1 是发送窗口
- P2-P1 是已经发送但尚未收到确认的字节数
- P3-P2 是允许发送但尚未发送的字节数

接收窗口后沿后面的是已经发送过确认的数据，窗口内的序号是允许接收的，接收方只能对按序接收的数据中的最高序号给出确认。接收方在返回确认之前还会返回可以接收的窗口大小，发送方需要根据大小调整发送窗口，当发送窗口内的数据全部发送但未收到确认就需要等待直到收到确认或者超时重试。

发送方的应用进程把字节流写入 TCP 的发送缓存，接收方的应用进程从 TCP 的接收缓存中读取字节流。缓存空间是循环使用的，且缓存空间的大小一般比滑动窗口大。

发送缓存用来存放发送应用程序传送给发送方 TCP 准备发送的数据 和 TCP 已经发送出但尚未接收到确认的数据。发送窗口通常只是发送缓存的一部分，已经确认的数据应当从发送缓存中删除，因此发送缓存和发送窗口的后沿是重合的。发送应用程序最后写入发送缓存的字节减去最后被确认的字节即使还保留在发送缓存中的被写入的字节数，发送应用程序必须控制写入缓存的速率，否则发送缓存就会没有存放数据的空间。

接收缓存用来存放按序到达的、尚未被接收应用程序读取的数据 和 未按序到达的数据。如果接收应用程序来不及读取收到的数据，接收缓存就会被填满，使接收窗口减小到零。


TCP 的发送方在规定的时间内没有收到确认就要重传已发送的报文段，超时时间设置的太短会引起不必要的报文段重传，而超时时间设置的太长会使得网络空闲时间太长降低传输效率。TCP 采用了一种自适应算法，记录每个报文段的发送到接收到确认的时间间隔 RTT，TCP 保留了 RTT 的一个加权平均往返时间 RTTs，其计算方式为 ```RTTs = (1-a)*RTTs + a*RTT```，a 一般取值 0.125。TCP 的超时重试时间(RTO, RetransmissionTimeOut) 应略大于 RTTs，其计算方式为 ```RTO = RTTs + RTTd```，其中 RTTd 是 RTT 的偏差加权平均值，计算方式为 ```RTTd = (1-b)*RTTd + b * |RTTs - RTT|```，b 一般取值 0.25。当发生数据报文重传时，报文段每重传一次就把超时重传时间 RTO 增加为之前的 2 倍，直到没有发生重传时才按照公式计算重传时间。

#### 流量控制

流量控制就是让发送方的发送速率不要太快从而使接收方能够来得及接收，TCP 的流量控制时基于滑动窗口实现的。

### 三次握手

### 四次挥手


time_wait

可靠性保证

## UDP 协议

可靠 udp 协议

## HTTP 协议

安全

https