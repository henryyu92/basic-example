## 事务

`Redis` 事务由 `multi`、`exec`、`discard` 和 `watch` 命令构成，他们允许在一个步骤中执行一组命令，在这个过程中 `Redis` 提供了两个重要的保证：

- 事务中所有的命令都按照顺序执行，服务器在执行事务的过程中不会执行其他客户端的请求
- 事务中的命令要么全部处理，要么都不处理，保证原子性。`exec` 命令触发事务中的所有命令执行，如果客户端在发送 `EXEC` 命令前断开连接，则事务不会执行

`Redis` 事务通过 `MULTI` 命令开启，然后客户端发送的所有命令都会被加入队列，直到客户端发送 `EXEC` 命令开始执行事务，或者发送 `DISCARD` 取消事务。

`Redis` 事务在执行的过程中会出现两种错误：

- 命令在加入队列的时候失败，也就是在执行 `EXEC` 命令之前失败，服务器在接收到 `EXEC` 命令时会拒绝执行事务并返回错误
- 命令在调用 `EXEC` 后开始执行时失败，此时队列中的其他命令会继续执行，`Redis`不会停止执行命令的过程

### 乐观锁

`WATCH` 命令为 `Redis` 事务提供了 `check-and-set(CAS)` 的行为，`WATCH` 会监视多个 key，在调用 `EXEC` 执行事务前如果有任意一个 key 发生了变化，则整个事务都不会执行。

乐观锁通常需要通过自旋的方式不断的执行 `CAS` 的动作直到执行成功。

```java
boolean succeed = false;
do{
    succeed = cas();
}while(!succeed);
```

- `WATCH` 监视的 key 如果过期，则调用 `EXEC` 命令时事务正常执行
- `WATCH` 命令可以多次调用，从第一次调用到调用 `EXEC` 命令之间的所有 `WATCH` 命令都会产生影响
-  `EXEC` 执行后，不管事务成功或者失败，被监视的 key 都不再被监视
- `Redis`提供的事务机制可以实现多命令的原子操作

