## 复制

Redis 提供了 `master-slave` 的复制机制，副本会保存和 master 上的数据拷贝，每次和 master 断开连接后都会自动重连到 master 并尝试和 master 的数据保持一致。Redis 的主从复制由三套机制保证：

- master 和 replica 连接正常时，master 向 replica 发送命令流使得包括客户端的写入、key 过期等造成 master 的数据集发生变化能够同步到 replica
- master 和 replica 的连接中断或者超时，replica 会尝试重新连接 master 并且继续尝试获取在断开连接期间丢失的部分数据流
- 当无法进行重新同步时，replica 会要求进行完全重新同步，此时 master 需要生成 rdb 快照然后发送到 replica，之后就继续发送命令流

Redis 的副本复制机制有如下特点：

- Redis 默认使用异步复制，副本异步的确认接收的数据量

- 每个 master 可以有多个副本

- 副本可以接收来自其他副本的连接，这样就可以使用副本通过主从复制的方式将数据在副本之间复制

- 复制的过程在 mater 是无阻塞的，因此在执行复制的过程中也可以对外提供服务
- 复制在副本端也是无阻塞的，在执行副本同步时的查询可以根据配置返回旧的数据，也可以返回错误。在同步完成后需要删除旧的数据，在初始化同步加载数据时，加载过程在主线程中，此过程会阻塞客户端的连接

### 复制原理

每个Redis主机都有一个复制ID：它是一个大的伪随机字符串，用于标记数据集的给定故事。每个主服务器还接受一个偏移量，该偏移量为它生成的要发送到副本的复制流的每个字节递增，以便用修改数据集的新更改来更新副本的状态。即使没有副本实际连接，复制偏移量也会增加，因此基本上每个给定的副本对：

```
Replication ID, offset
```

当复制副本连接到主机时，它们使用PSYNC命令来发送它们的旧主机复制ID和迄今为止处理的偏移量。这样，主机就可以发送所需的增量部分。但是，如果主缓冲区中没有足够的积压工作，或者如果复制副本引用的历史记录（复制ID）不再是已知的，则会发生完全重新同步：在这种情况下，复制副本将从零开始获取数据集的完整副本。

下面详细介绍了完全同步的工作原理：

 主机启动后台保存过程以生成RDB文件。同时，它开始缓冲从客户机接收到的所有新写命令。后台保存完成后，主机将数据库文件传输到副本，副本将其保存在磁盘上，然后将其加载到内存中。然后，主机将所有缓冲命令发送到复制副本。这是作为一个命令流来完成的，并且与Redis协议本身的格式相同。 

 如前所述，当主副本链路由于某种原因中断时，副本能够自动重新连接。如果主机接收到多个并发副本同步请求，它将执行单个后台保存以服务于所有这些请求。 