## 复制

Redis 提供了基于 `master-slave` 机制的复制功能，从节点保存着主节点上的数据拷贝。当从节点和主节点之间的连接断开时，从节点会自动重连到主节点并且尝试从主节点拷贝数据而不理会主节点上数据发生了什么变化(主节点数据丢失则会导致从节点删除数据)。

Redis 提供的复制机制包含三个阶段：

- 主节点和从节点连接正常时，主节点通过向从节点发送命令流把主节点上数据的变化(客户端更新、key 过期等)更新到从节点
- 主节点和从节点断开连接时，从节点会重连主节点并且尝试获取断开连接时的命令流从而和主节点的数据保持一致
- 如果从节点不能获取到命令流，则从节点会像主节点要求全量同步。主节点会生成 rdb 文件发送给从节点，然后继续发送后续的命令流

Redis 提供的复制机制有如下特点：

- 默认采用异步方式，并且从节点会异步的确认处理的数据量
- 每个主节点可以有多个从节点，从节点之间也可以复制数据
- 主节点的复制过程是异步的，也就是不管是全量同步还是增量同步过程中都是可以对外提供服务
- 从节点的复制过程也是异步的，在全量同步的过程中根据配置可以为查询返回旧数据或者错误，全量同步完成后需要删除旧的数据并加载新的数据，这个过程需要阻塞客户端的请求
- 通过副本机制可以实现读写分离，或者副本仅作为数据的备份
- 使用副本还可以让主节点不需要持久化，而将持久化设置在从节点，这种配置有可能在主节点重启时从节点将主节点的空数据集同步从而导致数据被清空

Redis 启用副本机制后建议在主节点和从节点都开启持久化，以避免主节点在重启后导致数据的丢失，如果由于某些原因使得不能开启持久化，则必须关闭节点的自动重启功能。数据丢失可能的情况为：

- 节点 A 为 master 并且没有开启持久化，节点 B 和节点 C 是 A 的从节点
- 节点 A 崩溃后重启，由于没有持久化机制，节点 A 的数据集为空
- 节点 B 和节点 C 从节点 A 同步空数据集，同步过程中会删除掉旧的数据



### 复制原理

每个主节点包含伪随机字符串的 `replica id` 和 `offset`，其中 `replica id` 是

当从节点连接到主节点后向主节点发送 `PSYNC` 命令将其保存的旧的 `replica ID` 和 `offset` 发送个主节点，主节点根据从节点发送的 offset 将增量的数据发送给从节点。

如果从节点和主节点的数据相差超过 `backlog` 的容量，或者从节点发送的 `replica ID` 在主节点查找不到则会触发全量的数据同步：

-  主节点启动后台进程创建 rdb 文件，同时所有的写命令都会被缓存起来
- rdb 文件创建完成后会发送给从节点，从节点加载磁盘中的数据到内存
- 主节点发送缓存的写命令给从节点

### 配置

最基础的主从复制配置只需要在从节点的配置文件增加如下配置项：

```
replicaof master_ip master_port
```

Reids 支持主节点 `backlog` 的调优，此外可以通过开启 `repl-diskless-sync` 来直接发送 rdb 而不用使用磁盘

```
repl-diskless-sync yes
```

